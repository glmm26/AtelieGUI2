{% extends "base.html" %}
{% block title %}Pedidos - Administração{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}
{% block content %}
<div class="back_adm">
    <div class="container_admin">
        <h2>Gestão de Pedidos</h2>

        <div class="admin_layout">
            <nav class="sidebar">
                <a href="{{ url_for('admin_dashboard') }}" class="btn">Sair</a>
                <a href="{{ url_for('clientes.listar_clientes') }}" class="btn">Clientes</a>
                <a href="{{ url_for('servicos.listar_servicos') }}" class="btn">Serviços</a>
                <a href="{{ url_for('materiais.listar_materiais') }}" class="btn">Materiais</a>
                <a href="{{ url_for('pedidos.listar_pedidos') }}" class="btn">Pedidos</a>
            </nav>

            <main class="main_panel">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% if pedidos and pedidos|length > 0 %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Serviço</th>
                                <th>Material</th>
                                <th>Descrição</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pedido in pedidos %}
                            <tr>
                                <td>{{ pedido.id }}</td>
                                <td>{{ pedido.nome_cliente or (pedido.usuario_id and pedido.usuario_id) }}</td>
                                <td>{{ pedido.tipo_servico }}</td>
                                <td>{{ pedido.material or '-' }}</td>
                                <td>{{ pedido.descricao or '-' }}</td>
                                <td>{{ pedido.data_pedido.strftime('%d/%m/%Y %H:%M') if pedido.data_pedido else '-' }}</td>
                                <td>{{ pedido.status or 'Pendente' }}</td>
                                <td>{{ pedido.status_atualizado_por or '-' }}</td>
                                <td>
                                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                        <form method="post" action="{{ url_for('pedidos.atualizar_status', id=pedido.id) }}" style="display:flex;gap:6px;align-items:center;">
                                            <select name="status" aria-label="Status do pedido">
                                                <option value="Pendente" {% if (pedido.status or 'Pendente') == 'Pendente' %}selected{% endif %}>Pendente</option>
                                                <option value="Em Progresso" {% if pedido.status == 'Em Progresso' %}selected{% endif %}>Em processo</option>
                                                <option value="Entregue" {% if pedido.status == 'Entregue' %}selected{% endif %}>Entregue</option>
                                                <option value="Concluida" {% if pedido.status == 'Concluida' %}selected{% endif %}>Concluída</option>
                                                <option value="Recusada" {% if pedido.status == 'Recusada' %}selected{% endif %}>Recusada</option>
                                            </select>
                                            <button class="btn" type="submit">Atualizar</button>
                                        </form>

                                        <form method="post" action="{{ url_for('pedidos.excluir_pedido', id=pedido.id) }}" onsubmit="return confirm('Deseja realmente excluir este pedido?');">
                                            <button class="btn btn-danger" type="submit">Excluir</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div>Nenhum pedido encontrado.</div>
                {% endif %}

            </main>
        </div>

    </div>
</div>
{% endblock %}
